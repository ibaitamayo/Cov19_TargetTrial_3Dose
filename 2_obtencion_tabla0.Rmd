---
title: "Criterios de exclusión estáticos"
output: 
  html_document:
    code_folding: show
    highlight: espresso
    css: style.css
    keep_md: yes
    number_sections: yes
    theme: readable
    toc: yes  
    toc_float:
      collapsed: yes
      smooth_scroll: yes
      toc_depth: 3     
editor_options: 
  chunk_output_type: inline
---


```{r set-global-options, echo = FALSE}
knitr::opts_chunk$set(eval = TRUE, 
                      echo = TRUE, 
                      cache = FALSE,
                      include = TRUE,
                      collapse = FALSE,
                       dependson = NULL,
                      engine = "R", # Chunks will always have R code, unless noted
                      error = TRUE,
                      fig.path="Figures/",  # Set the figure options
                      fig.align = "center", 
                      fig.width = 12,
                      fig.height = 12)
```

```{r librerias, echo=FALSE, message=FALSE, include = FALSE, warning=FALSE}
# source("0_a_librerias.R")
# ya se cargan cuando se carguen las funciones

```

```{r}
# función para cargar un .Rmd como si se hiciese source de un .r---------------
source_rmd = function(file, ...) {
  tmp_file = tempfile(fileext=".R")
  on.exit(unlink(tmp_file), add = TRUE)
  knitr::purl(file, output=tmp_file)
  source(file = tmp_file, ...)
}

```

```{r}
# cargar funciones de 0_funciones----------------------------------------------
source_rmd("0_b_funciones.rmd")

```


```{r cargar-datos, echo=FALSE, eval=TRUE, message=FALSE, warning=FALSE}
# cargar datos-----------------------------------------------------------------
load(file.path("Datos", "Brutos", "ttcvc3d_220628.Rdata"))

```

# Introducción

***

Cuando situamos el punto 0 (en Navarra a ppios de diciembre ya comenzaba la escalada). no se porque el paper plantea enero2022, ¿quizás porque es entonces cuando empieza la tercera dosis?

por lo que veo para octubre ya estaban las dos primeras dosis...esto es importante para aplicar el calculo de los test previos al punto 0/ exclusiones de casos positivos...// voy a hacerlo ahora con los datos del articulo... pero entiendo que lo suyo es llevarlo a un mes (211201) o mes y medio (211115) antes!

# Exclusiones estáticas

***

Definir exclusiones flow chart

```{r flujo}
# 1 unable to link to National Registry (registro de personas con cupo en AP-publica)
# 2 health-care workers or social workers PRFSS TRU 22719
# 3 resident in nursing home or in an institution: RESN TRUE  3970+6060=10030 
# 4 high level of functional dependency severa:5127, grandep 2712  (como se hace en jerarquia este 7839 n - no tiene porque corresponder.. sera el n tras excluir los casos anteriores).. tenemos otra variable.. mirar en el chunck, al final hago un mix entre gdep y depe de vacunas-infeccion.. total 11036 DEPE TRUE
# 5 invalid post code is.na(CZBS)

```


```{r exclusión}
#PRFSS RESN DEPE CZBS

##Tiempo dependientes
# 6 SARS-CoV-2 infection before Dec 23, 2021  (SACAR DE LA FUNCION TABLA0 -EN RELACION AL T0-)
# 7 not completely vaccinated  VCIX 156434 (no tiEmpo dependiente) o se ha completado al menos tres meses antes del T0..[#9 989 156 booster dose before Dec 23, 2021]


## NO
# first vaccine before general recommendation by age  (? - TENDRIA QUE ELABORAR) (Only individuals who received their first dose after the recommended vaccination date for their age group were included (appendix p 2))
# received ChAdOx1 nCoV-19 or mRNA heterologous vaccination
# booster dose with unknown type of mRNA vaccine  (NO) NO DISTINGUIREMOS ENTRE VACUNAS O RNA-OTRAS

```


## Time series of exposure and outcome (T0 = Jan 3, 2022)

```{r series temporales, echo=FALSE, eval=TRUE, message=FALSE, include = TRUE, warning=FALSE}



## como son las distribuciones de vacunacion e infeccion####
### serie temporal de vacunaciones ####

min <- as.Date("2021-01-01")
max <- NA

ggplotly(ggplot(data = pobana  %>% group_by(fvc2) %>% summarise(n=n()) %>% na.omit(), aes(x = fvc2, y = n))+ geom_line(color = "#E7B800", size = 1) + scale_x_date(limits = c(min, max), date_labels = "%b/%y") +stat_peaks(colour = "purple") +ggtitle("Segunda dosis"))


ggplotly(ggplot(data = pobana  %>% group_by(fcv1) %>% summarise(n=n()) %>% na.omit(), aes(x = fcv1, y = n))+ geom_line(color = "#E7B800", size = 1) + scale_x_date(limits = c(min, max), date_labels = "%b/%y") +stat_peaks(colour = "purple") +ggtitle("Infecciones"))


min <- as.Date("2021-09-01")
max <- NA

ggplotly(ggplot(data = pobana  %>% group_by(fvc3) %>% summarise(n=n()) %>% na.omit(), aes(x = fvc3, y = n))+ geom_line(color = "#E7B800", size = 1) + scale_x_date(limits = c(min, max), date_labels = "%b/%y") +stat_peaks(colour = "purple") +ggtitle("Tercera dosis"))
         
        

```

# Programación

## f_tabla0: genera la tabla de análisis inicial

 * *parametro*: fecha 0 de arranque -primera cohorte-(por defecto 2022-01-14)
 * *entrada*: 
    + a. tabla de poblacion-vacunas-infecciones: pobana
    + b. tabla de test previos
 * *salida*: tabla de analisis 
            * a la que se agrega el numero de test negativos previos (0,1,2,3+)
            * filtra                  y excluye aquellos con  infeccion previa/
                                                      # sociosanitario/
                                                      # educación/
                                                      # viven en residencia/
                                                      # dependientes/ 
                                                      # zbs desconocida
             * selecciona variables para el analisis, pasando a numericas las candidatas para el matching 
             
             
```{r f_tabla0, message=FALSE, include = TRUE, warning=FALSE}

f_tabla0<-function(fecha0="2022-01-14", file_Rdata_poblacion="Rdata/pobana.Rdata",file_Rdata_test="Rdata/test220613.Rdata") {
  fecha0=ymd(fecha0)
  print("Asegurate de que Knit Directory es Current working directory")
  if (!"pobana"%in% ls(envir = .GlobalEnv)){
    load(file_Rdata_poblacion,envir = .GlobalEnv)
  }
  if (!"test220613"%in% ls(envir = .GlobalEnv)){
  load(file_Rdata_test,envir = .GlobalEnv )
  }
  get("pobana", envir = .GlobalEnv)->pobana
  get("test220613", envir = .GlobalEnv)->test220613
  print(paste("n de partida :",nrow(pobana)))
  print("Excluyendo: socio y/o sanitarios...") 
  pobana %>% filter(is.na(prfss) | prfss!=TRUE)->pobana
    print(paste("n :",nrow(pobana)))
  print("Excluyendo: trabj educacion...") 
    pobana %>% filter(is.na(educa) | educa!=TRUE)->pobana 
    print(paste("n :",nrow(pobana)))  
  print("Excluyendo: viven en residencia...") 
  pobana %>% filter(is.na(resn) | resn!=TRUE)->pobana
    print(paste("n :",nrow(pobana)))
  print("Excluyendo:dependientes...")   
  pobana %>% filter(is.na(depe) | depe!=TRUE)->pobana
    print(paste("n :",nrow(pobana)))
  print("Excluyendo: zona basica desconocida...")   
  pobana %>% filter(!is.na(czbs))->pobana 
    print(paste("n :",nrow(pobana)))
  print("Excluyendo: tuvo infección previa...")
  pobana %>% filter(cvsn==0|fcv1>=ymd(fecha0))->pobana
    print(paste("n :",nrow(pobana)))
  print("Excluyendo: no finalizo vacunacion completa 90 dias antes...")
  pobana %>% filter(fecha0-fvc2>90)->tabla_0_pobana
     print(paste("n :",nrow(tabla_0_pobana))) 
  print("calculando tests negativos previos...[aplicar la t0!!]")
  test220613%>% filter(id %in% tabla_0_pobana$id &tpos==FALSE & ftes<ymd(fecha0)) %>% group_by(id)%>% summarise(n_0=max(n)) %>% right_join(tabla_0_pobana, by="id") %>% mutate(n_0=ifelse(is.na(n_0),0,ifelse(n_0>3,3,n_0)), tv2=as.numeric(ymd(fecha0)-fvc2))->pobana_n_tabla0
  
 pobana_n_tabla0 <- pobana_n_tabla0 %>% mutate(
    genn=as.numeric(gen)-1,
    gedadn=as.numeric(gedad),
    czbs=as.numeric(czbs),
    migran=as.numeric(migran),
    vgp20=as.numeric(vgp20),
    vgp21=as.numeric(vgp21),
    tvc2n=as.numeric(as.factor(tvc2))) %>% dplyr::select(id,fvc2,fvc3,fdef,fcv1,fih1,genn,gedad,gedadn,czbs,n_0,tvc2n,tvc3,tv2,migran,vgp20,vgp21,ucn8) 
 
  return(pobana_n_tabla0)
}


# lo aplico empleando como inicio 2022-01-03": genera el flow_chart
 

 f_tabla0(fecha0="2022-01-03")->tab0220103  # 437897
 table(tab0220103$n_0)
#      0      1      2      3 
# 117739  68311  49929  68391 

#     0      1      2      3 
# 130922  69452  48407  55589 


```


## f_exclusion: criterios de exclusión tiempo-dependientes

* *parametro*: datos + fecha 0 de arranque -primera cohorte-
* *entrada*: tabla filtrada por f_tabla0
* *salida*: tabla de analisis 
            * filtra y excluye aquellos con:
            
                     + con fecha de 3 dosis anterior al t0/
                     + fallecidos o /
                     + infectados previamente/
                                                     

```{r, message=FALSE, include = TRUE, warning=FALSE}

f_exclusion= function(data, fecha0) {
data= data %>% filter(is.na(fvc3) | fecha0 <= fvc3,
           is.na(fcv1) | fecha0 < fcv1,
           is.na(fdef) |  fecha0 < fdef)
return(data)           
}


```


