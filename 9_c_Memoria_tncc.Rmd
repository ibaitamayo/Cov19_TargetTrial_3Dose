---
title: "Target Trial: Test negative case control"
author: "Francisco Sánchez Sáez"
date: "`r format(Sys.Date())`"
output: 
  bookdown::html_document2:
    keep_md: false 
    theme: cerulean
    highlight: breezedark
    css: style.css
    anchor_sections: false
    toc: yes
    toc_float:
      collapsed: yes
      smooth_scroll: yes
      code_folding: show
    toc_depth: 3
bibliography: References.bib
csl: tl.csl
editor_options: 
  chunk_output_type: inline
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

```

```{r echo=FALSE, message=FALSE, include=FALSE, warning=FALSE}
# source("0_a_librerias.R")
# ya se cargan cuando se carguen las funciones

```

```{r echo=FALSE, message=FALSE, include=FALSE, warning=FALSE}
# función para cargar un .Rmd como si se hiciese source de un .r---------------
source_rmd = function(file, ...) {
  tmp_file = tempfile(fileext = ".R")
  on.exit(unlink(tmp_file), add = TRUE)
  knitr::purl(file, output = tmp_file)
  source(file = tmp_file, ...)
}

```

```{r echo=FALSE, message=FALSE, include=FALSE, warning=FALSE}
# cargar funciones de 0_funciones----------------------------------------------
if (!exists("se_ha_cargado_f")) {
suppressMessages(source_rmd("0_b_funciones.rmd"))
}

```

```{r definir_plot, echo=FALSE, warning=FALSE, message=FALSE}
# definir el estilo de los gráficos--------------------------------------------
theme_set(theme_bw())
tema_azul <- theme_update(
  plot.background = element_rect(fill = "aliceblue", colour = "black"),
  strip.background = element_rect(colour = "black", fill = "white"))

```


# Introducción

***

En este documento se muestra la utilización de un diseño de Análisis caso control negativo en el tiempo desde prueba diagnóstica (*test negative case control*). En particular, se realiza la emulación del ensayo clínico partiendo del caso (individuo con test positivo) y emparejando con un control que se haya realizado una prueba diagnóstica ese mismo día (individuo con test negativo).


Para comprobar el funcionamiento del diseño **tncc** se realizan tres análisis:

1) Un análisis donde se estudia a la población general sin aplicar criterios de exclusión dependientes del tiempo (los criterios de exclusión independientes del tiempo sí que se han aplicado: no trabajadores sanitarios ni de educación, no residentes, etc.).

2) Se excluyen a los individuos que no tengan la pauta *primaria* de vacunación (2 dosis de Pfizer, AZ y Moderna, o al menos 1 dosis de Janssen) con una antigüedad de 90 o más días en el *tiempo_0*.

3) Se excluyen a los individuos que **no tengan la pauta *primaria*** de vacunación (2 dosis de Pfizer, AZ y Moderna, o al menos 1 dosis de Janssen) con una antigüedad de 90 o más días en el *tiempo_0*, y, además, se excluyena los individuos que **hayan tenido infección por COVID-19 previa** al *tiempo_0*.

# Análisis 1 

***

Se estudia a la población general filtrada por criterios de exclusión independientes del tiempo (*Pobana_2*: población sin criterios de exclusión dependientes del tiempo). En esta población, existen 6 categorías posibles de tratamiento:

1) Sin pauta de vacunación previa completa (sin booster), y sin registro de COVID-19 previa.
2) Sin pauta de vacunación previa completa (sin booster), y con registro de COVID-19 previa.
3) Con pauta de vacunación previa completa, sin booster, y sin registro de COVID-19 previa.
4) Con pauta de vacunación previa completa, sin booster, y con registro de COVID-19 previa.
5) Con pauta de vacunación previa completa, con booster, y sin registro de COVID-19 previa.
6) Con pauta de vacunación previa completa, con booster, y con registro de COVID-19 previa.

<br>

```{r}
res_analisis_1 <- readRDS(file.path("Resultados", "res_analisis_1.RDS"))

ci_res_1 <- (1 - exp(confint(res_analisis_1))) %>% 
  as_tibble(rownames = "treatment") %>% 
  mutate(estimate = 1 - exp(coef(res_analisis_1))) %>% 
  rename(lw_ci = `2.5 %`,
         up_ci = `97.5 %`) %>% 
  mutate(description =
           c("Booster: no.  Vaccination: no.  Previous infection: yes",
             "Booster: no.  Vaccination: yes. Previous infection:  no",
             "Booster: no.  Vaccination: yes. Previous infection: yes",
             "Booster: yes. Vaccination: yes. Previous infection:  no",
             "Booster: yes. Vaccination: yes. Previous infection: yes")) %>% 
  mutate(prev_inf = c("yes",
                      "no",
                      "yes",
                      "no",
                      "yes"))
             
ggplot(ci_res_1) +
  geom_errorbar(aes(x = description, ymin = lw_ci, ymax = up_ci, 
                    colour = prev_inf),
                width=.2,) +
  geom_point(aes(x = description, y = estimate, colour = prev_inf)) +
  scale_x_discrete(name = "Treatment", labels = label_wrap(25)) +
  labs(caption = "Reference treatment is: Booster: no.  Vaccination: no.  Previous infection: no") +
  scale_colour_manual(values = c("green", "red"), guide = NULL) +
  scale_y_continuous(name = "Effectivity", breaks = seq(-1, 1, 0.2),
                     labels = label_percent()) 
  
```

<br>

# Análisis 2

***

Se estudia a mayores de 40 con pauta previa completa. Por lo tanto, van a existir 4 categorías posibles de tratamiento:

1) Sin booster y sin registro de COVID-19 previa.
2) Sin booster y con registro de COVID-19 previa.
3) Con booster y sin registro de COVID-19 previa.
4) Con booster y con registro de COVID-19 previa.

<br>

```{r}
res_analisis_2 <- readRDS(file.path("Resultados", "res_analisis_2.RDS"))

ci_res_1 <- (1 - exp(confint(res_analisis_1))) %>% 
  as_tibble(rownames = "treatment") %>% 
  mutate(estimate = 1 - exp(coef(res_analisis_1))) %>% 
  rename(lw_ci = `2.5 %`,
         up_ci = `97.5 %`) %>% 
  mutate(description =
           c("Booster: no.  Vaccination: no.  Previous infection: yes",
             "Booster: no.  Vaccination: yes. Previous infection:  no",
             "Booster: no.  Vaccination: yes. Previous infection: yes",
             "Booster: yes. Vaccination: yes. Previous infection:  no",
             "Booster: yes. Vaccination: yes. Previous infection: yes")) %>% 
  mutate(prev_inf = c("yes",
                      "no",
                      "yes",
                      "no",
                      "yes"))
             
ggplot(ci_res_1) +
  geom_errorbar(aes(x = description, ymin = lw_ci, ymax = up_ci, 
                    colour = prev_inf),
                width=.2,) +
  geom_point(aes(x = description, y = estimate, colour = prev_inf)) +
  scale_x_discrete(name = "Treatment", labels = label_wrap(25)) +
  labs(caption = "Reference treatment is: Booster: no.  Vaccination: no.  Previous infection: no") +
  scale_colour_manual(values = c("green", "red"), guide = NULL) +
  scale_y_continuous(name = "Effectivity", breaks = seq(-1, 1, 0.2),
                     labels = label_percent()) 
  
```

<br>


# Análisis 3

***

Se estudia a los mayores de 40, con pauta previa y sin COVID previa. Por lo tanto, únicamente se tienen 2 categorías de tratamiento:

1) Sin booster.
2) Con booster.

<br>

```{r}

```

<br>

# References

***
