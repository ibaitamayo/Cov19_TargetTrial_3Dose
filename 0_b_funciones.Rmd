---
title: "Funciones"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---


```{r set-global-options, echo = FALSE}
knitr::opts_chunk$set(eval = TRUE, 
                      echo = TRUE, 
                      cache = FALSE,
                      include = TRUE,
                      collapse = FALSE,
                      dependson = NULL,
                      engine = "R", # Chunks will always have R code, unless noted
                      error = TRUE,
                      fig.path="Figures/",  # Set the figure options
                      fig.align = "center", 
                      fig.width = 12,
                      fig.height = 12)
```


```{r librerias, echo=FALSE, message=FALSE, include=FALSE, warning=FALSE}
source("0_a_librerias.R")

```

# Descripción

***

En este .Rmd van a estar todas las funciones que se utilizarán para la creación del target trial, así como otras funciones auxiliares que se van a utilizar para el limpiado de la base y la creación de los resultados. El objetivo último, es acabar convirtiendo este .Rmd en un paquete de R. Como manera de estructurar el trabajo, cada función irá por separado en un chunk.

# Funciones auxiliares

***

En esta sección se encuentran las funciones auxiliares

## fymd

Función que transforma los 10 primeros carácteres de una cadena en una fecha mediante la función de ymd de la librería lubridate.

```{r fymd}
# fecha en texto a ymd
fymd <- function(x) {
  x = as.Date(ymd(str_sub(x, 1, 10)))
  }

```

## fnullna

Función que transforma una cadena con texto "NULL" a NA.

```{r fnullna}

fnullna <- function(x) {
  x = if_else(x == "NULL", NA_character_, x)
  }

```

# Funciones del Target Trial

***

## excluir

Función que realiza un criterio de exclusión a partir de una variable de un tibble.

```{r}
# función para excluir siguiendo un criterio-----------------------------------
excluir <- function(pob, 
                    crit,
                    var)
{
  
  if (is.logical(pob %>% pull(var)) == TRUE) {
  print(glue("Variable lógica. {crit}"))
  pob <- pob %>% filter(is.na(get(var)) |
                     get(var) != TRUE)
    print(glue("n : {nrow(pob)}"))
  pob
  }
  else {
  print(glue("Variable no lógica. {crit}"))
  pob <- pob %>% filter(!is.na(get(var)))
    print(glue("n : {nrow(pob)}"))
  pob
  }
}

```

## hacer_flujo

Está función aplica los criterios de exclusión uno detras de otro, informando del flow.

```{r}
# flujo------------------------------------------------------------------------
hacer_flujo <- function(poblacion,
                        exc = lista_exclusion
                   ) 
  {
  print(glue("n de partida: {nrow(poblacion)}"))

  for( i in seq_along(exc$criterios)) {
  poblacion <- excluir(pob = poblacion,
                         crit = exc$criterios[[i]],
                         var = exc$variables[[i]])
}
  poblacion
  }
  
```


