---
title: "Análisis caso control negativo en el tiempo desde prueba"
output: 
  html_document:
    code_folding: show
    highlight: espresso
    css: 
    keep_md: yes
    number_sections: yes
    theme: readable
    toc: yes  
    toc_float:
      collapsed: yes
      smooth_scroll: yes
      toc_depth: 3     
editor_options: 
  chunk_output_type: inline
---


```{r set-global-options, echo = FALSE}
knitr::opts_chunk$set(eval = TRUE, 
                      echo = TRUE, 
                      cache = FALSE,
                      include = TRUE,
                      collapse = FALSE,
                       dependson = NULL,
                      engine = "R", # Chunks will always have R code, unless noted
                      error = TRUE,
                      fig.path="Figures/",  # Set the figure options
                      fig.align = "center", 
                      fig.width = 12,
                      fig.height = 12)
```

```{r librerias, echo=FALSE, message=FALSE, include=FALSE, warning=FALSE}
# source("0_a_librerias.R")
# ya se cargan cuando se carguen las funciones

```

```{r}
# función para cargar un .Rmd como si se hiciese source de un .r---------------
source_rmd = function(file, ...) {
  tmp_file = tempfile(fileext = ".R")
  on.exit(unlink(tmp_file), add = TRUE)
  knitr::purl(file, output = tmp_file)
  source(file = tmp_file, ...)
}

```

```{r}
# cargar funciones de 0_funciones----------------------------------------------
if (!exists("se_ha_cargado_f")) {
suppressMessages(source_rmd("0_b_funciones.rmd"))
}

```


```{r cargar-datos, echo=FALSE, eval=TRUE, message=FALSE, warning=FALSE}
# cargar datos-----------------------------------------------------------------
pobana_2 <- readRDS(file = file.path("Resultados", "pobana_2.RDS"))
test220613_cleaned <- readRDS(file = file.path("Datos", "Procesados", 
                                             "test220613_cleaned.RDS"))

```

```{r}
tiempo_0 <- ymd("2022-01-03")
base_test <- test220613_cleaned

# arreglar fcv1 con respecto a los ingresos hospitalarios
data_0 <- pobana_2 %>% 
  tidylog::mutate(fcv1 = if_else(!is.na(fih1) & is.na(fcv1),
                                 fih1, fcv1))

data_0 %>% 
  filter(fih1 >= ymd("2022-01-03")) %>% 
  count(fih1, fcv1, fcv2)

  # exclusión covid positivo en los 90 días previos al test
  data1 <- data_0 %>%
    filter(
      is.na(fcv1) |
      as.numeric(tiempo_0 - fcv1) >= 90 | 
      as.numeric(tiempo_0 - fcv1) <= 0,
      is.na(fcv2) |
      as.numeric(tiempo_0 - fcv2) >= 90 | 
      as.numeric(tiempo_0 - fcv2) <= 0)
  
  data1 %>% count(fcv1, fcv2)
  
  data2 <- data1 %>% 
    mutate(fcv1_prev = if_else((as.numeric(tiempo_0 - fcv1) >= 90) == TRUE,
                               fcv1, NA_Date_))
  
  data2 %>% count(fcv1, fcv1_prev)
  
  # obtención número de test negativos previos al primer positivo
  data3 <- base_test %>% filter(id %in% data2$id,
                               ftes == tiempo_0) %>%
     inner_join(data2, by = "id")
  
  # introducir edad como variable de matching respecto a tiempo_0
  data4 <- data3 %>% 
    mutate(p_edad_cat = cut(as.numeric(difftime(tiempo_0, fnac, 
                                              unit = "days"))/365.25,
                          right = FALSE, 
                          breaks = c(0,
                                     seq(20, 70, by = 10),
                                     200))) %>% 
    mutate(p_edad_cat_label = p_edad_cat)
  
  # exposicion-seguimiento
  vector_match <- c("gen", "migran", "p_edad_cat")
  
  suppressWarnings(data5 <- data4 %>%
    mutate(across(.cols = all_of(vector_match), 
                  .fns = ~if_else(is.na(as.numeric(.x)) == TRUE, 
                                  as.numeric(as.factor(.x)),
                                  as.numeric(.x)))))      
  
  data <- data5 %>% 
    mutate(exposicion = if_else(tpos == TRUE, 1, 0),
           date_start = tiempo_0)
    
  # hacer matching (investigar distintas opciones)
  data_out <- try({
    greedymatch <- Matching::Match(Tr = data$exposicion, M = 1, 
                   X = data[vector_match], exact = TRUE, ties = FALSE,
                   replace = TRUE)
    a <- data[unlist(greedymatch[c("index.treated", "index.control")]),]
    par <- rep(1:(nrow(a)/2), 2)
    bind_cols(par = par, a) %>%
      group_by(par) %>% 
      as_tibble() 
    }
  )

data_out %>% count(exposicion)  

data_out %>% count(fcv1 == ymd("2022-01-03"))
data_out %>% count(fcv2 == ymd("2022-01-03"))

data_out %>% filter(exposicion == 1, 
                    fcv1 != ymd("2022-01-03") | fcv2 != ymd("2022-01-03"))

```

```{r}
# logística condicional
data_out2 <- data_out %>% 
  rename(caso = exposicion) %>% 
  mutate(tratamiento = case_when(
    is.na(fvc2) & is.na(fcv1_prev) ~ 1,
    is.na(fvc2) & !is.na(fcv1_prev) ~ 2,
    !is.na(fvc2) & is.na(fvc3) & is.na(fcv1_prev) ~ 3,
    !is.na(fvc2) & is.na(fvc3) & !is.na(fcv1_prev) ~ 4,
    !is.na(fvc3) & is.na(fcv1_prev) ~ 5,
    !is.na(fvc3) & !is.na(fcv1_prev) ~ 6
  )) %>% 
  mutate(tratamiento = as_factor(tratamiento))

data_out2 %>% skimr::skim(fcv1_prev)

data_out2 %>% count(tratamiento)

clogit(caso ~ tratamiento + strata(par), data = data_out2)

```

