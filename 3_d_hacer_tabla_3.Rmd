---
title: "Análisis de supervivencia"
output: 
  html_document:
    code_folding: show
    highlight: espresso
    css: 
    keep_md: yes
    number_sections: yes
    theme: readable
    toc: yes  
    toc_float:
      collapsed: yes
      smooth_scroll: yes
      toc_depth: 3     
editor_options: 
  chunk_output_type: inline
---


```{r set-global-options, echo = FALSE}
knitr::opts_chunk$set(eval = TRUE, 
                      echo = TRUE, 
                      cache = FALSE,
                      include = TRUE,
                      collapse = FALSE,
                       dependson = NULL,
                      engine = "R", # Chunks will always have R code, unless noted
                      error = TRUE,
                      fig.path="Figures/",  # Set the figure options
                      fig.align = "center", 
                      fig.width = 12,
                      fig.height = 12)
```

```{r librerias, echo=FALSE, message=FALSE, include=FALSE, warning=FALSE}
# source("0_a_librerias.R")
# ya se cargan cuando se carguen las funciones

```

```{r}
# función para cargar un .Rmd como si se hiciese source de un .r---------------
source_rmd = function(file, ...) {
  tmp_file = tempfile(fileext = ".R")
  on.exit(unlink(tmp_file), add = TRUE)
  knitr::purl(file, output = tmp_file)
  source(file = tmp_file, ...)
}

```

```{r}
# cargar funciones de 0_funciones----------------------------------------------
if (!exists("se_ha_cargado_f")) {
suppressMessages(source_rmd("0_b_funciones.rmd"))
}

```


```{r}
# cargar datos-----------------------------------------------------------------
matching_fcv1 <- readRDS(file.path("Resultados",
        "matching_fcv1.RDS"))

matching_fcv1_domi <- readRDS(file.path("Resultados",
        "matching_fcv1_domi.RDS"))

```


# Table 3: Sensitivity analyses of vaccine effectiveness 7–34 days after an mRNA COVID-19 vaccine booster dose // 1–risk ratio (95% CI) | Risk difference per 10 000 individuals (95% CI)

***

Main analysis | Restricting to people with ≥1 negative lab test at enrolment | with no tests in the 7  days before enrollment |Censoring matched pairs 7 days after the control receives a booster rather than 0 days | Using date of PCR test result rather than subtracting 2 days | Selecting matched controls without replacement | Exact matching by age (year by year vs 5-year groups) | Restricting events to PCR test.

## Main Analysis

```{r}
# arreglar tibble
  tt_tibble_after_7_days <- matching_fcv1$tt_tibble %>% 
  # filtrar parejas con seguimiento después del día 7
      mutate(survtime = date_end - date_start) %>% 
      group_by(target_trial_number, par) %>% 
      filter(min(survtime) >= tiempo_efecto) %>%
      ungroup() %>% 
  # crear tiempo desde pauta completa
      mutate(
        t_desde_pauta_completa = 90 + temp_var,
        t_desde_pauta_completa_cat = case_when(
          between(t_desde_pauta_completa, 91, 195) ~  "91-195 days",
          between(t_desde_pauta_completa, 196, 220) ~ "196-220 days",
        t_desde_pauta_completa > 221 ~  "&ge; 221 days"),
        t_desde_pauta_completa_cat = factor(t_desde_pauta_completa_cat,
          levels = c("91-195 days", "196-220 days", "&ge; 221 days")))

# arreglar tibble
  tt_tibble_after_7_days <- tt_tibble %>% 
  # filtrar parejas con seguimiento después del día 7
      mutate(survtime = date_end - date_start) %>% 
      group_by(target_trial_number, par) %>% 
      filter(min(survtime) >= tiempo_efecto) %>%
      ungroup() %>% 
  # crear tiempo desde pauta completa
      mutate(
        t_desde_pauta_completa = 90 + temp_var,
        t_desde_pauta_completa_cat = case_when(
          between(t_desde_pauta_completa, 91, 195) ~  "91-195 days",
          between(t_desde_pauta_completa, 196, 220) ~ "196-220 days",
        t_desde_pauta_completa > 221 ~  "&ge; 221 days"),
        t_desde_pauta_completa_cat = factor(t_desde_pauta_completa_cat,
          levels = c("91-195 days", "196-220 days", "&ge; 221 days")))

  tt_tibble_after_7_days_pairs <- tt_tibble_after_7_days %>% 
    filter(exposicion == 1) %>% nrow()

# hacer estratos tabla 3
  table3_overall <- hacer_grupo_tabla_2(
    tt_tibble = tt_tibble_after_7_days, 
    group_description = "Overall",
    number_of_bootstrap = 500)
  
  table3_ntest_mayor_que_0 <- hacer_grupo_tabla_2(
    tt_tibble = tt_tibble_after_7_days %>% 
      filter(n_0 >= 1), 
    group_description = "Restricting to people with &ge; 1 negative lab test at enrolment",
    number_of_bootstrap = 500)
  
```

## Sensitivity Analysis

```{r cargar-datos, echo=FALSE, eval=TRUE, message=FALSE, warning=FALSE}
# cargar datos-----------------------------------------------------------------
pobana_2 <- readRDS(file = file.path("Resultados", "pobana_2.RDS"))

test220613_cleaned <- readRDS(file = file.path("Datos", "Procesados", 
                                             "test220613_cleaned.RDS"))


```

```{r}
# se crean listas que dependen del proyecto------------------------------------
lista_exclusion_dep <- list(
  criterios = list(
  c1 = "Excluyendo: infección previa antes del tiempo_0...",
  c2 = "Excluyendo: edad < 40 años en tiempo_0...", 
  c3 = "Excluyendo: pauta incompleta 90 días antes del tiempo_0...",
  c4 = "Excluyendo: fallecidos antes del tiempo_0...",
  c5 = "Excluyendo: boosting antes del tiempo_0..."),
  variables = list(
  v1 = "fcv1",
  v2 = "fnac_40",
  v3 = "fpauta_90",
  v4 = "fdef",
  v5 = "fvc3"),
  tipo_var = list(
    "exc",
    "inc",
    "inc",
    "exc",
    "exc")
  )

```

```{r}
# vectores de matching---------------------------------------------------------
variables_matching = c(
  "gen",    # 1
  "gedad",  # 2
  "czbs",   # 3
  "tvc1",   # 4
  "migran", # 5
  "vgp20",  # 6
  "vgp21",  # 7
  "ucn8",   # 8
  "domi")   # 9

```


```{r}
# matching f_pauta en semanas (menos restrictivo)
prueba_matching_weeks <- f_matching_tt(
                data = pobana_2,
                tiempo_0 = "2022-01-03",
                crit_exc = lista_exclusion_dep,
                exposure = "fvc3",
                out = "fcv1", 
                vector_match = variables_matching[c(1, 3:8)], 
                base_test = test220613_cleaned,
                dias_a_excluir_test_previos = NULL,
                temporal_var = "fpauta_90",
                temporal_var_unit = "weeks",
                birth_date = "fnac",
                age_first = 40,
                age_last = 90,
                age_by = 1,
                censoring = "fdef",
                follow_up = 34,
                verbose = FALSE,
                seed = 3)

prueba_matching_weeks2 <-f_matching_tt(
                data = pobana_2,
                tiempo_0 = "2022-01-03",
                crit_exc = lista_exclusion_dep,
                exposure = "fvc3",
                out = "fcv1", 
                vector_match = variables_matching[c(1, 3:8)],
                match_with_replacement = FALSE,
                base_test = test220613_cleaned,
                dias_a_excluir_test_previos = NULL,
                temporal_var = "fpauta_90",
                temporal_var_unit = "weeks",
                birth_date = "fnac",
                age_first = 40,
                age_last = 90,
                age_by = 5,
                censoring = "fdef",
                follow_up = 34,
                verbose = FALSE,
                seed = 3)

```

