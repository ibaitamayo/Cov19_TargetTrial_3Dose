---
title: "Análisis de supervivencia"
output: 
  html_document:
    code_folding: show
    highlight: espresso
    css: style.css
    keep_md: yes
    number_sections: yes
    theme: readable
    toc: yes  
    toc_float:
      collapsed: yes
      smooth_scroll: yes
      toc_depth: 3     
editor_options: 
  chunk_output_type: inline
---


```{r set-global-options, echo = FALSE}
knitr::opts_chunk$set(eval = TRUE, 
                      echo = TRUE, 
                      cache = FALSE,
                      include = TRUE,
                      collapse = FALSE,
                       dependson = NULL,
                      engine = "R", # Chunks will always have R code, unless noted
                      error = TRUE,
                      fig.path="Figures/",  # Set the figure options
                      fig.align = "center", 
                      fig.width = 12,
                      fig.height = 12)
```

```{r echo=FALSE, message=FALSE, include=FALSE, warning=FALSE}
# source("0_a_librerias.R")
# ya se cargan cuando se carguen las funciones

```

```{r}
# función para cargar un .Rmd como si se hiciese source de un .r---------------
source_rmd = function(file, ...) {
  tmp_file = tempfile(fileext = ".R")
  on.exit(unlink(tmp_file), add = TRUE)
  knitr::purl(file, output = tmp_file)
  source(file = tmp_file, ...)
}

```

```{r}
# cargar funciones de 0_funciones----------------------------------------------
if (!exists("se_ha_cargado_f")) {
suppressMessages(source_rmd("0_b_funciones.rmd"))
}

```

# Análisis de supervivencia Omicrón-España

***

Se realizan los análisis como el artículo de Monge-Hernán

```{r}
# cargar datos tt Monge-Hernán-------------------------------------------------
matching_fcv1 <- readRDS(file.path("Resultados",
        "matching_fcv1.RDS"))
matching_fcv1_sens1 <- readRDS(file.path("Resultados",
        "matching_fcv1_sens1.RDS"))
matching_fcv1_sens2 <- readRDS(file.path("Resultados",
        "matching_fcv1_sens2.RDS"))
matching_fcv1_sens3 <- readRDS(file.path("Resultados",
        "matching_fcv1_sens3.RDS"))
matching_fcv1_sens4 <- readRDS(file.path("Resultados",
        "matching_fcv1_sens4.RDS"))
matching_fcv1_sens5 <- readRDS(file.path("Resultados",
        "matching_fcv1_sens5.RDS"))
# prueba domicilio-------------------------------------------------------------
matching_fcv1_domi <- readRDS(file.path("Resultados",
        "matching_fcv1_domi.RDS"))

```

## Análisis principal

```{r}
# análisis con variables de matching como el artículo--------------------------
f_analisis(lista = matching_fcv1,
           tiempo_efecto = 7,
           lim_1 = 0.8,
           lim_zoom = 0.9)

```

## Sensibilidad 0

No hace falta ejecutar la f_matching de nuevo. Se hace un filtrado en el tibble de la lista y con eso es suficiente.

```{r}
# análisis con variables de matching como el artículo--------------------------
matching_fcv1_sens0 <- matching_fcv1
matching_fcv1_sens0$tt_tibble <- matching_fcv1_sens0$tt_tibble %>%
  filter(n_0 >= 1)

saveRDS(matching_fcv1_sens0, file.path("Resultados", "matching_fcv1_sens0.RDS"))

f_analisis(lista = matching_fcv1_sens0,
           tiempo_efecto = 7,
           lim_1 = 0.8,
           lim_zoom = 0.9)

```

## Sensibilidad 1

```{r}
# análisis con variables de matching como el artículo--------------------------
f_analisis(lista = matching_fcv1_sens1,
           tiempo_efecto = 7,
           lim_1 = 0.8,
           lim_zoom = 0.9)

```

## Sensibilidad 2

```{r}
# análisis con variables de matching como el artículo--------------------------
f_analisis(lista = matching_fcv1_sens2,
           tiempo_efecto = 7,
           lim_1 = 0.8,
           lim_zoom = 0.9)

```

## Sensibilidad 3

```{r}
# análisis con variables de matching como el artículo--------------------------
f_analisis(lista = matching_fcv1_sens3,
           tiempo_efecto = 7,
           lim_1 = 0.8,
           lim_zoom = 0.9)

```

## Sensibilidad 4

```{r}
# análisis con variables de matching como el artículo--------------------------
f_analisis(lista = matching_fcv1_sens4,
           tiempo_efecto = 7,
           lim_1 = 0.8,
           lim_zoom = 0.9)

```

## Sensibilidad 5

```{r}
# análisis con variables de matching como el artículo--------------------------
f_analisis(lista = matching_fcv1_sens5,
           tiempo_efecto = 7,
           lim_1 = 0.8,
           lim_zoom = 0.9)

```

# Prueba con domicilio

```{r}
# análisis con domicilio como variable de matching-----------------------------
f_analisis(lista = matching_fcv1_domi,
           tiempo_efecto = 7,
           lim_1 = 0.80,
           lim_zoom = 0.9)

```

# fcv1 Longer

```{r}
# guardar resultados-----------------------------------------------------------
matching_fcv1_longer <- readRDS(file.path("Resultados",
        "matching_fcv1_longer.RDS"))

```

```{r}
# análisis---------------------------------------------------------------------
f_analisis(lista = matching_fcv1_longer,
           tiempo_efecto = 7,
           lim_1 = 0.80,
           lim_zoom = 0.9)

```

# fih1 Longer

```{r}
# guardar resultados-----------------------------------------------------------
matching_fih1_longer <- readRDS(file.path("Resultados",
        "matching_fih1_longer.RDS"))

```

```{r}
# análisis---------------------------------------------------------------------
f_analisis(lista = matching_fih1_longer,
           tiempo_efecto = 7,
           lim_1 = 0.997,
           lim_zoom = 0.998)

```
